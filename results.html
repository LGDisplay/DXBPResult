<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ì  ê²°ê³¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #2980b9;
        }

        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #229954;
        }

        .file-info {
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .score-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            font-size: 1.1em;
        }

        .rank-1 { background: #f1c40f; }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: #3498db; }

        .score-high { background: #27ae60; }
        .score-medium { background: #f39c12; }
        .score-low { background: #e74c3c; }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì±„ì  ê²°ê³¼</h1>
            <p style="color: #7f8c8d; margin-top: 10px;">BGK 70% + ê´€ê° 30% = ìµœì¢… ì ìˆ˜ Ã· 2</p>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <a href="index.html" class="back-btn">â† ì±„ì  í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
                <button id="deleteAllBtn" class="back-btn" style="background: #e74c3c; border: none; cursor: pointer;">
                    ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ
                </button>
            </div>
        </div>

        <!-- <div class="upload-section">
            <h3>ğŸ“„ ê´€ê° íˆ¬í‘œ ì ìˆ˜</h3>
            <p id="audienceStatus" style="color: #7f8c8d;">
                íŒŒì¼ ë¡œë”© ì¤‘... (a.txt)
            </p>
        </div> -->

        <div id="loading" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('final')">ğŸ† ìµœì¢… ê²°ê³¼</button>
                <button class="tab-btn" onclick="switchTab('raw')">ğŸ“‹ Raw Data</button>
            </div>

            <!-- Tab 1: ìµœì¢… ê²°ê³¼ -->
            <div id="finalTab" class="tab-content active">
                <div class="results-table">
                    <h2 style="margin-bottom: 20px; color: #333;">ìµœì¢… ìˆœìœ„ (ëŒ€ê²° ë°©ì‹)</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">
                        ê° ì¹´í…Œê³ ë¦¬ì—ì„œ 2ëª…ì”© ëŒ€ê²° â†’ ë†’ì€ ì ìˆ˜ê°€ 1ë“±, ë‚®ì€ ì ìˆ˜ê°€ 2ë“±
                    </p>
                    
                    <!-- ëŒ€ê²° 1: ê²€ì‚¬/í’ˆì§ˆ -->
                    <h3 style="color: #3498db; margin: 20px 0 10px 0;">ğŸ† ê²€ì‚¬/í’ˆì§ˆ ë¶€ë¬¸</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í›„ë³´ì</th>
                                <th>BGK í‰ê· <br>(70%)</th>
                                <th>ê´€ê° íˆ¬í‘œ<br>(30%)</th>
                                <th>í•©ê³„</th>
                                <th>ìµœì¢… ì ìˆ˜<br>(Ã·2)</th>
                                <th>ì±„ì í•œ BGK ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="group1Body">
                        </tbody>
                    </table>

                    <!-- ëŒ€ê²° 2: ìš´ì˜/ìƒì‚° -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">ğŸ† ìš´ì˜/ìƒì‚° ë¶€ë¬¸</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í›„ë³´ì</th>
                                <th>BGK í‰ê· <br>(70%)</th>
                                <th>ê´€ê° íˆ¬í‘œ<br>(30%)</th>
                                <th>í•©ê³„</th>
                                <th>ìµœì¢… ì ìˆ˜<br>(Ã·2)</th>
                                <th>ì±„ì í•œ BGK ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="group2Body">
                        </tbody>
                    </table>

                    <!-- ëŒ€ê²° 3: ê³µì •/ì„¤ë¹„ -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">ğŸ† ê³µì •/ì„¤ë¹„ ë¶€ë¬¸</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í›„ë³´ì</th>
                                <th>BGK í‰ê· <br>(70%)</th>
                                <th>ê´€ê° íˆ¬í‘œ<br>(30%)</th>
                                <th>í•©ê³„</th>
                                <th>ìµœì¢… ì ìˆ˜<br>(Ã·2)</th>
                                <th>ì±„ì í•œ BGK ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="group3Body">
                        </tbody>
                    </table>

                    <!-- ëŒ€ê²° 4: ì„¤ê³„/ê°œë°œ -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">ğŸ† ì„¤ê³„/ê°œë°œ ë¶€ë¬¸</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í›„ë³´ì</th>
                                <th>BGK í‰ê· <br>(70%)</th>
                                <th>ê´€ê° íˆ¬í‘œ<br>(30%)</th>
                                <th>í•©ê³„</th>
                                <th>ìµœì¢… ì ìˆ˜<br>(Ã·2)</th>
                                <th>ì±„ì í•œ BGK ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="group4Body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: Raw Data -->
            <div id="rawTab" class="tab-content">
                <div class="results-table">
                    <h2 style="margin-bottom: 20px; color: #333;">ì „ì²´ ì±„ì  ë‚´ì—­ (ìµœì‹ ìˆœ)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>í‰ê°€ì</th>
                                <th>í›„ë³´ì</th>
                                <th>Idea ë°œêµ´</th>
                                <th>ì‹¤íš¨ê³¼</th>
                                <th>Biz íŒŒê¸‰íš¨ê³¼</th>
                                <th>ì´ì </th>
                            </tr>
                        </thead>
                        <tbody id="rawDataBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ========================================
        // THAY CONFIG GIá»NG FILE INDEX.HTML
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyD4kO0rxRLfnLnPIwr6mtgLs0utzVS_qMk",
            authDomain: "scoring-system-4993c.firebaseapp.com",
            projectId: "scoring-system-4993c",
            storageBucket: "scoring-system-4993c.firebasestorage.app",
            messagingSenderId: "9687384907",
            appId: "1:9687384907:web:50e9969d943076c924dece"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Chia thÃ nh 4 nhÃ³m Ä‘áº¥u
        const groups = [
            { name: "ê²€ì‚¬/í’ˆì§ˆ", contestants: ["ê²€ì‚¬/í’ˆì§ˆ 1", "ê²€ì‚¬/í’ˆì§ˆ 2"], bodyId: "group1Body" },
            { name: "ìš´ì˜/ìƒì‚°", contestants: ["ìš´ì˜/ìƒì‚° 1", "ìš´ì˜/ìƒì‚° 2"], bodyId: "group2Body" },
            { name: "ê³µì •/ì„¤ë¹„", contestants: ["ê³µì •/ì„¤ë¹„ 1", "ê³µì •/ì„¤ë¹„ 2"], bodyId: "group3Body" },
            { name: "ì„¤ê³„/ê°œë°œ", contestants: ["ì„¤ê³„/ê°œë°œ 1", "ì„¤ê³„/ê°œë°œ 2"], bodyId: "group4Body" }
        ];

        let audienceScores = {};
        let allScores = [];

        // Auto load audience scores from a.txt
        async function loadAudienceScores() {
            try {
                const response = await fetch('a.txt');
                if (!response.ok) {
                    throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                const text = await response.text();
                audienceScores = parseAudienceScores(text);
                
                const statusEl = document.getElementById('audienceStatus');
                if (statusEl) {
                    statusEl.style.color = '#27ae60';
                    statusEl.innerHTML = `âœ… ê´€ê° íˆ¬í‘œ ë¡œë“œ ì™„ë£Œ: ${Object.keys(audienceScores).length}ëª…<br><small>íŒŒì¼: a.txt</small>`;
                }
                
                if (allScores.length > 0) {
                    calculateFinalResults();
                }
            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                const statusEl = document.getElementById('audienceStatus');
                if (statusEl) {
                    statusEl.style.color = '#e74c3c';
                    statusEl.innerHTML = `âŒ a.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br><small>ê°™ì€ í´ë”ì— a.txt íŒŒì¼ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”</small>`;
                }
            }
        }

        // Switch tabs
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'final') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('finalTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('rawTab').classList.add('active');
            }
        };

        function parseAudienceScores(text) {
            const scores = {};
            const lines = text.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                const match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)$/);
                if (match) {
                    const name = match[1].trim();
                    const score = parseFloat(match[2]);
                    scores[name] = score;
                }
            });
            
            return scores;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getScoreBadgeClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 50) return 'score-medium';
            return 'score-low';
        }

        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }

        async function loadResults() {
            try {
                console.log('ğŸ” Báº¯t Ä‘áº§u load dá»¯ liá»‡u tá»« Firebase...');
                const q = query(collection(db, "scores"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                console.log('ğŸ“Š Sá»‘ lÆ°á»£ng documents:', querySnapshot.size);

                if (querySnapshot.empty) {
                    console.log('âš ï¸ Database trá»‘ng!');
                    document.getElementById('loading').innerHTML = 
                        '<div class="no-data">ì•„ì§ ì±„ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € index.htmlì—ì„œ ì±„ì ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</div>';
                    return;
                }

                allScores = [];
                querySnapshot.forEach((doc) => {
                    console.log('âœ… Document:', doc.data());
                    allScores.push(doc.data());
                });

                displayRawData();
                calculateFinalResults();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('âŒ Lá»—i Firebase:', error);
                console.error('âŒ Error code:', error.code);
                console.error('âŒ Error message:', error.message);
                document.getElementById('loading').innerHTML = 
                    `<div class="no-data">
                        âŒ Lá»—i: ${error.message}<br>
                        <small>Code: ${error.code}</small><br>
                        <small style="color: #e74c3c;">Má»Ÿ F12 Console Ä‘á»ƒ xem chi tiáº¿t</small>
                    </div>`;
            }
        }

        function displayRawData() {
            const tbody = document.getElementById('rawDataBody');
            tbody.innerHTML = '';

            allScores.forEach(data => {
                const row = `
                    <tr>
                        <td>${formatDate(data.timestamp)}</td>
                        <td><strong>${data.judgeName}</strong></td>
                        <td>${data.contestantName}</td>
                        <td>${data.innovationScore}</td>
                        <td>${data.presentationScore}</td>
                        <td>${data.technicalScore}</td>
                        <td>
                            <span class="score-badge ${getScoreBadgeClass(data.totalScore)}">
                                ${data.totalScore.toFixed(1)}
                            </span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function calculateFinalResults() {
            groups.forEach(group => {
                const results = [];

                group.contestants.forEach(contestant => {
                    // Láº¥y Ä‘iá»ƒm cuá»‘i cÃ¹ng cá»§a má»—i BGK cho thÃ­ sinh nÃ y
                    const judgeLatestScores = {};
                    
                    allScores.forEach(score => {
                        if (score.contestantName === contestant) {
                            if (!judgeLatestScores[score.judgeName]) {
                                judgeLatestScores[score.judgeName] = score.totalScore;
                            }
                        }
                    });

                    const judgeScoresArray = Object.values(judgeLatestScores);
                    const judgeCount = judgeScoresArray.length;

                    if (judgeCount === 0) return;

                    // TÃ­nh trung bÃ¬nh BGK
                    const bgkAvg = judgeScoresArray.reduce((a, b) => a + b, 0) / judgeCount;

                    // Äiá»ƒm khÃ¡n giáº£
                    const audienceScore = audienceScores[contestant] || 0;

                    // TÃ­nh Ä‘iá»ƒm cuá»‘i
                    const bgkWeighted = bgkAvg * 0.7;
                    const audienceWeighted = audienceScore * 0.3;
                    const total = bgkWeighted + audienceWeighted;
                    const finalScore = total / 2;

                    results.push({
                        contestant,
                        bgkAvg: bgkAvg.toFixed(2),
                        bgkWeighted: bgkWeighted.toFixed(2),
                        audienceScore: audienceScore.toFixed(2),
                        audienceWeighted: audienceWeighted.toFixed(2),
                        total: total.toFixed(2),
                        finalScore: finalScore.toFixed(2),
                        judgeCount
                    });
                });

                // Sáº¯p xáº¿p theo Ä‘iá»ƒm cuá»‘i giáº£m dáº§n trong nhÃ³m
                results.sort((a, b) => parseFloat(b.finalScore) - parseFloat(a.finalScore));

                displayGroupResults(results, group.bodyId);
            });
        }

        function displayGroupResults(results, bodyId) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">ì±„ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            results.forEach((result, index) => {
                const rank = index + 1; // 1 hoáº·c 2
                const rankText = rank === 1 ? "1ë“±" : "2ë“±";
                const row = `
                    <tr>
                        <td>
                            <span class="score-badge ${getRankClass(rank)}">
                                ${rankText}
                            </span>
                        </td>
                        <td><strong>${result.contestant}</strong></td>
                        <td>${result.bgkAvg}<br><small>(${result.bgkWeighted})</small></td>
                        <td>${result.audienceScore}<br><small>(${result.audienceWeighted})</small></td>
                        <td><strong>${result.total}</strong></td>
                        <td>
                            <span class="score-badge ${getScoreBadgeClass(parseFloat(result.finalScore) * 2)}">
                                ${result.finalScore}
                            </span>
                        </td>
                        <td>${result.judgeCount} / 7</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Load data
        loadAudienceScores();
        loadResults();

        // Auto refresh every 30 seconds
        setInterval(loadResults, 30000);

        // Delete all data
        document.getElementById('deleteAllBtn').addEventListener('click', async function() {
            const confirmed = confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ì±„ì  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤!\n\nì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) return;

            const doubleConfirm = confirm('ğŸš¨ ë§ˆì§€ë§‰ í™•ì¸: ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!doubleConfirm) return;

            try {
                this.disabled = true;
                this.textContent = 'ì‚­ì œ ì¤‘...';

                const q = query(collection(db, "scores"));
                const querySnapshot = await getDocs(q);

                let deleteCount = 0;
                const deletePromises = [];

                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, "scores", document.id)));
                    deleteCount++;
                });

                await Promise.all(deletePromises);

                alert(`âœ… ì„±ê³µ: ${deleteCount}ê°œì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                // Reload page
                location.reload();

            } catch (error) {
                console.error('âŒ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                this.disabled = false;
                this.textContent = 'ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ';
            }
        });
    </script>
</body>
</html>